---
title: "The Cluster Depth Tests"
subtitle: "Massively Univariate Tests for EEG"
author: "Jaromil Frossard"
institute: "University of Geneva"
date: "2021/11/14 (updated: `r Sys.Date()`)"
output:
  xaringan::moon_reader:
    css: xaringan-themer.css
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---
class: left, middle


```{r xaringanExtra, echo=FALSE}
xaringanExtra::use_tile_view()
xaringanExtra::use_clipboard()
xaringanExtra::use_scribble()
xaringanExtra::use_fit_screen()
xaringanExtra::use_progress_bar(color = "#0051BA", location = "top")
```



```{r library, include=FALSE, warning=FALSE}
library(dplyr)
library(tidyr)
library(purrr)
library(ggplot2)
library(permuco)
library(patchwork)
library(glue)
library(stringr)


library(permuco)
library(Matrix)
library(ggrepel)
library(ggpubr)

source("function/theme_jf.R")


source("script/plot_erps.R",echo = F)
source("script/plot_bonferroni.R",echo = F)
source("script/plot_perm.R",echo = F)
source("script/plot_maxt.R",echo = F)
source("script/plot_cluster.R",echo = F)
source("script/plot_cluster_hist.R",echo = F)
source("script/plot_problem_clustermass.R",echo = F)
source("script/plot_clusterdepth.R",echo = F)
source("script/plot_cdepth_hist.R",echo = F)


```


## Table of Content

- Testing Conditions in EEG
    - Family wise error rate (FWER)
    - Parametric vs non-parametric tests
- Max-T/min-p procedure
- Cluster mass test
- Cluster depth tests


---
class: left, top


## Testing Conditions in EEG




```{r erps, echo=FALSE, fig.height=6, fig.width=10, warning=FALSE, dev="svg"}
gg_erps
```

---
class: left, top

### Multiple Tests

.center[
600 ms at 512Hz = 614 Time-Points!
]

--

#### Several approaches:

- Pre-selecting a few tests (*a prior* knowledge, miss effects)
- Average over a time frame (*a prior* knowledge, interpretation on the time window)
- Testing all time-points (increase FWER) `r emo::ji("-1")`
- Testing all time-points + multiple comparisons procedure. `r emo::ji("+1")`

--

#### Multiple comparisons procedure:

- Parametric: Bonferroni (Dunn 1958), Holm (Holm 1979)
- Point-wise non-parametric: min-p/max-T (Westfall and Young 1993) , Troendle (Troendle 1995)
- Cluster-wise non-parametric: Cluster Mass Test (Maris and Oostenveld 2007), TFCE (Smith and Nichols 2009)
- Hybrid non-parametric: Cluster Depth Tests (Frossard and Renaud 2021a)


---
class: left, top

### Family-Wise Error Rate

#### Definition
- $\text{FWER} = \text{Prob}(\text{At least 1 type 1 Error})$.
- Probability of reporting at least one false positive.

When we observe signals of length $m$, some time points are under the **null hypothesis** the other are under the **alternative hypothesis**.

Declaring significant 1 time point that comes from a null hypothesis constitutes a type 1 error.

-- 

#### Bonferroni

- We change the univariate $\alpha$'s to $\alpha/m$.
- We multiply the univariate p-values by $m$.
- `r emo::ji("+1")` We only need univariate p-values.
- `r emo::ji("-1")` Low power.



<!-- -- -->

<!-- |       |non-significant|significant|        | -->
<!-- |:------|:-------------:|:---------:|:------:| -->
<!-- |True H0| U             |V          | m0     | -->
<!-- |True HA| T             |S          | m - m0 | -->
<!-- |       |m-R            |R          |m       | -->


<!-- $$\text{FWER} = \text{Prob}(V>0)$$ -->

---
class: center, top

### Univariate Tests under H0

.center[
```{r bonf, echo=FALSE, fig.height=6, fig.width=10, warning=FALSE, dev="svg"}
gg_bonf
```
]

<!-- --- -->
<!-- class: left, top -->

<!-- #### Example:  -->
<!-- - Running 10'000 experiments where **only random noise** is observed.  -->
<!-- - On average, 500 of them contain at least 1 significant time point using the statistical method $\mathcal{M}$.  -->
<!-- - $\mathcal{M}$ has a FWER of $\text{FWER}=500/10000 = 5\%$. -->

<!-- -- -->




---
class: center, middle, inverse


### Multiple comparisons procedures based on resampling 


---
class: left, top

### Max-T/ min-p

\begin{align}
\text{FWER} &= \text{Prob}_{\text{H}_0}\left(\text{At least one statistic } T_i > \text{critical } T^*\right)\\
&= \text{Prob}_{\text{H}_0}\left(\text{max}_i(T_i) > \text{critical } T^*\right)
\end{align}

.center[
Same rational with p-values using the minimum!
]

--

### Distribution of the maximum

- Depend on the **correlation between the tests**.
- **No parametric model** of the correlation between test is accurate.
- **Permutation tests** capture the correlation under H0.

---
class: left, top


```{r perm, echo=FALSE, fig.height=8, fig.width=10, warning=FALSE, dev="svg"}
gg_perm
```


---
class: left, top


```{r perm_hist, echo=FALSE, fig.height=8, fig.width=10, warning=FALSE, dev="svg"}
gg_hist_maxt
```


---
class: left, middle

### Pluses and minuses

- `r emo::ji("+1")` Point-wise interpretation.
- `r emo::ji("+1")` Take into account the correlation.
- `r emo::ji("+1")` More powerful than Bonferroni-Holm.
- `r emo::ji("-1")` Fail when there is to manly equivalent uncorrelated tests.
- `r emo::ji("-1")` Do not take into account the spatio-temporal distribution of the tests.
- `r emo::ji("-1")` For min-p, when the number of test is too large, we need to increase the number of permutations.


### Interpretation

.center[
We take an $\alpha_{\text{FWER}}$ level risk when we concluding: "Each significant time points are under H1".
]

---
class: left, top

### Step-wise argument

1. Sorting the observed statistics $T_{(1)}>\dots>T_{(i)}>\dots> T_{(m)}$.
2. Using the Bonferroni procedure for the decision of the hypothesis $H_{(1)}$ associated to $T_{(1)}$ while considering the hypothesis $H_{(1)},\dots,H_{(m)}$ ($\tilde p_{(1)} =,p_{(1)}$).
3. If we do not reject $H_{(1)}$, then we do not reject $H_{(1)},\dots,H_{(m)}$
4. If we reject $H_{(1)}$, 

    a.  We correctly rejected $H_{(1)}$. We can  only consider $H_{(2)},\dots,H_{(m)}$ when testing $H_{(2)}$ ( $\tilde p_{(2)} =(m-1) p_{(2)}$ ).
    
    b. We falsely rejected $H_{(1)}$. We can also only consider $H_{(2)},\dots,H_{(m)}$ when testing $H_{(2)}$ ( $\tilde p_{(2)} =(m-1) p_{(2)}$ ).


--

### Step-wise procedure

- Bonferroni + Step-wise argument => Holm
- min-p + Step-wise argument => Troendle

---
class: center, middle, inverse


# Cluster-based resampling procedure: the cluster mass test

---
class: left, top


```{r cluster, echo=FALSE, fig.height=8, fig.width=10, warning=FALSE, dev="svg"}
gg_cl
```


---
class: left, top


```{r hist_cluster, echo=FALSE, fig.height=8, fig.width=10, warning=FALSE, dev="svg"}
gg_hist_cm
```


---
class: left, top

### Pluses and minuses

- `r emo::ji("+1")` Take into account the spatio-temporal position of the tests.
- `r emo::ji("+1")` Very powerful.
- `r emo::ji("-1")` True discoveries include many false positives.
- `r emo::ji("-1")` Cluster-wise interpretation
- `r emo::ji("-1")` Weak control of the FWER.

--
### Interpretation


.center[
We take an $\alpha_{\text{FWER}}$ level risk when concluding: "There is at least 1 time point under H1".

When **all time points** are under H0, we have a $\alpha_{\text{FWER}}$ probability to observed a significant cluster.
]

---
class: left, top

```{r problem, echo=FALSE, fig.height=8, fig.width=10, warning=FALSE, dev="svg"}
gg_fp
```


---
class: center, middle, inverse

# The threshold-free cluster enhancement (TFCE)


---
class: left, top

## Rationale

- Removing the threshold the need of a threshold.
- Integral over all thresholds.
- Controlling the FWER using a max-T argument.


$$\text{TFCE}_s =\int_{h = 0}^{h=T_s} e(h)^E h^H \text{d}h$$

.center[https://benediktehinger.de/blog/science/tag/tfce/]

--
 
In EEG, we often use $E=0.5$ and $H=1$ or $H=2$, depending on the statistic (t or F).

When $E<1$, the influence of the length of a cluster is small. It has the advantage to decreases the risk of false positive at the border of true effects.




---
class: center, middle, inverse


# The cluster depth tests: a point-wise interpretation 


---
class: left, top


## Rational


- From the cluster mass test, we **keep the threshold** defining clusters.
- We reject the idea of a cluster mass. We **do not aggregate the statistics**.


- The cluster depth is the position of a time point __relatively to the border of the cluster__.
- The cluster depth can be defined "from the head" or "from the tail".

--

.center[
We test relatively to the cluster depth: "The first time point a cluster is under H0." 

H0: __No difference at the 1st cluster depth__ from the head.

Then, we generalized to all cluster-depths.
]


---
class: left, top

```{r cdepth, echo=FALSE, fig.height=8, fig.width=10, warning=FALSE, dev="svg"}
gg_cdepth
```


---
class: left, top

```{r cdepth_hist, echo=FALSE, fig.height=8, fig.width=10, warning=FALSE, dev="svg"}
gg_cdepth_hist
```


---
class: left, top


### Interpretation

- We take a $\alpha_{\text{FWER}}$ when we declare: "We found at least one cluster that begin no later at time $t_0$...


### Work in progress

- Combining cluster depth *from the head* and *from the tail* to find the starting and ending of the clusters. 
- Implementation in `permuco` (Frossard and Renaud 2021b): the p-values are the time-wise maximal $p$-values between the cluster depth *from the head* and *from the tail*.


---
class: left, top

### `permuco`

cran: https://CRAN.R-project.org/package=permuco/
github: https://github.com/jaromilfrossard/permuco/
website: https://jaromilfrossard.github.io/permuco/
article: https://www.jstatsoft.org/article/view/v099i15/

### `permuco4brain`

github: https://github.com/jaromilfrossard/permuco4brain/
website: jaromilfrossard.github.io/permuco4brain/

--

[Rscript](https://github.com/jaromilfrossard/clusterdepth_slide/script_clusterdepth.R)

---
class: left, top

# References

- Dunn, O. J. (1958). Estimation of the means of dependent variables. *The Annals of Mathematical Statistics, 1095-1111*.
- Frossard, J., & Renaud, O. (2021a). The Cluster Depth Tests: Toward Point-Wise Strong Control of the Family-Wise Error Rate in Massively Univariate Tests with Application to M/EEG. *arXiv preprint arXiv:2105.07514*.
- Frossard, J., & Renaud, O. (2021b). Permutation Tests for Regression, ANOVA, and Comparison of Signals: The permuco Package. Journal of Statistical Software, 99, 1-32.
- Holm, S. (1979). A simple sequentially rejective multiple test procedure. *Scandinavian journal of statistics*, 65-70.
- Maris, E., & Oostenveld, R. (2007). Nonparametric statistical testing of EEG-and MEG-data. *Journal of neuroscience methods, 164*(1), 177-190.
- Smith, S. M., & Nichols, T. E. (2009). Threshold-free cluster enhancement: addressing problems of smoothing, threshold dependence and localisation in cluster inference. *Neuroimage, 44*(1), 83-98.
- Tipura, E., Renaud, O., & Pegna, A. J. (2019). Attention shifting and subliminal cueing under high attentional load: an EEG study using emotional faces. *Neuroreport, 30*(18), 1251-1255.
- Troendle, J. F. (1995). A stepwise resampling method of multiple hypothesis testing. *Journal of the American Statistical Association, 90*(429), 370-378.
- Westfall, P. H., & Young, S. S. (1993). *Resampling-based multiple testing: Examples and methods for p-value adjustment* (Vol. 279). John Wiley & Sons.



